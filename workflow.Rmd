```{r init}
#stop('Don\'t run me dummy')
#rm(list=ls()) # clear workspace
cat('\014') # clear console
knitr::opts_chunk$set(
  eval=T
  ,include=F
)
library(tilit);library(magrittr)
'data.table,disk.frame,ggplot2' %>% ec %>% sapply(library,character.only = T) %>% invisible # load packages
setDTthreads(percent=2) # binder limits combined cpu load to 1 core's worth, so core use should be discounted
#if(parallel::detectCores()>1&getDTthreads()==1) setDTthreads(threads=2)
nc<-getDTthreads() # for functions asking for number of cores
nchnk<-nc*2^3
{DF<-T;if(DF) {setup_disk.frame();options(future.globals.maxSize = Inf)}} # set up disk frame
if(!dir.exists('d')) system('mkdir d && (cd d && mkdir q d p b)') # create data directory structure if it doesn't exist
cpumem<-function(plot=T) {
  'cpumem.R' %>% {if(file.exists(.)) sprintf("Rscript -e \"suppressPackageStartupMessages(source(\'%s\'))\"",.)} %>% system(wait = F)
  if(plot) Sys.getenv('RSTUDIO_HTTP_REFERER') %>% {if(.!='') if(interactive()) {
    Sys.sleep(2)
    browseURL(sprintf('%sexport/cpumem.png?name=cpumem.png&file=~%%2Fcpumem.png',.))
    browseURL(sprintf('%sfiles/cpumem.png',.))
  }}
}
cpumem(F)
```
# Import WOK Data

```{r wok2dbl}
# create link to original location in clean data structure 
if(!file.exists('d/p/wok2dbl.RData')) system('link Out/wok2dbl.RData d/p/wok2dbl.RData')
# Code that would generate database, but load saved data instead. Note original WOK records absent from repository.
f<-'d/p/wok2dbl.RData'
if(file.exists(f)){
  load(f)
} else {
  wok2dbl<-plagiat::wok2dbl.f(dir = 'WoS.TextFiles.19Sept2018.61551/', out = 'Out')
  save(wok2dbl,file=f)
}
wok2dbl<-unique(wok2dbl)
rm(f)
if(DF) wok2dfl<-as.disk.frame(wok2dbl)
```

```{r cpumem1}
cpumem(T)
```

<!--
## WOK Descriptives

```{r descriptive}
nut<-wok2dbl[,id %>% unique %>% length]
n<-wok2dbl['CR',on='field',.N,by=val][,table(N)] %>% {data.table(N=as.integer(names(.)),nn=as.integer(.))}
n[,cs:=cumsum(nn)]
n[,cp:=round(cs/max(cs),4)]
n[,rcs:=cumsum(nn %>% rev)]
n[rcs>=180542]
n
n[,rcs:=NULL]
n
n %>% setorder(-N)
n
n[,rcs:=cumsum(nn)]
n
n[rcs>=180542]
n[rcs<180542]
wok2dbl['CR',on='field',unique(val) %>% length]

```
-->

# Bimodal edge list

```{r dbl2bel}
f<-'d/p/dbl2bel.RData'
if(file.exists(f)){
  rm(wok2dbl)
  load(f)
} else {
  dbl2bel<-plagiat::dbl2bel.f(wok2dbl,out=dirname(f),trim_doi = T,trim_anon = T,trim_loops = T,capitalize = T,trim_pendants = T) %>% invisible
  save(dbl2bel,file=f)
  rm(wok2dbl)
}
r<-attributes(dbl2bel)$results
dbl2bel<-unique(dbl2bel[!(pend|loop),.(ut,cr)]) %>% setkey(ut,cr)
dbl2bel[,`:=`(ut=factor(ut),cr=factor(cr))] %>% setkey(ut,cr)
lut<-gzfile(paste(dirname(f),'bel2mel-ut-levs.txt.gz',sep=.Platform$file.sep),'w')
writeLines(dbl2bel[,levels(ut)],lut)
lcr<-gzfile(paste(dirname(f),'bel2mel-cr-levs.txt.gz',sep=.Platform$file.sep),'w')
writeLines(dbl2bel[,levels(cr)],lcr)
dbl2bel[,ut:=as.integer(ut)][,cr:=as.integer(cr)] %>% setkey(ut,cr)

if(DF) {
  dfl2bel<-as.disk.frame(dbl2bel,nchunks = nchnk,shardby = 'ut')
  attr(dfl2bel,'results')<-r
  rm(dbl2bel)
}
r
rm(f,r)
```

<!--
```{r memtest}
f<-'d/q/memtest.RData'
if(F) if(file.exists(f)){
load(f)
ggplot(data=mt,aes(y=byt,x=ix)) + geom_jitter(aes(color=factor(ix)) )+ scale_x_log10()  + scale_y_continuous(trans='log2') + geom_smooth(method = 'lm',formula=y~poly(x,2))
} else {
mt<-list()
setkey(dbl2bel,ut,cr)
for(ix in 10^(1:4)) mt[[as.character(ix)]]<-data.table(
ix=ix,byt=
pbapply::pbreplicate(
n = 100,
object.size(
dbl2bel[sample(ut,ix),data.table(do.call(rbind,lapply(1:(length(cr) - 1), function(y) matrix(cr[c(rep(y,length(cr) - y), (y + 1):length(cr))], ncol = 2)))),by = ut] %>% setnames(old=c('V1','V2'),new=c('cr1','cr2'))
)
,simplify = T,cl=2)
)
mt<-rbindlist(mt)
save(mt,file=f)
}
rm(f)
```
-->

```{r cpumem2}
cpumem(T)
```

# Unimodal edgelist

```{r bel2mel}
f<-'d/p/bel2mel.RData'
if(file.exists(f)){
  load(f)
} else 
{
  #bel2mel<-plagiat::bel2mel.f(dbl2bel,type = 'crel',out = dirname(f))
  bel2mel<-list()
  sub('$','.txt',f) %>% {if(file.exists(.)) {file.remove(.);warning(sprintf('Removed %s before writing new lines.',.))}}
  if(DF) {
    cat('\nStarting dfl2bel -> bel2mel.RData.txt.')
    dfl2bel[
      ,data.table(ut=ut,do.call(what='rbind',lapply(1:(length(cr) - 1), function(y) matrix(cr[c(rep(y,length(cr) - y), (y + 1):length(cr))], ncol = 2)))) %>% setnames(old=c('V1','V2'),new=c('cr1','cr2')) %>% 
        fwrite(file = sub('$','.txt',f),append=T,quote = F,sep = '\t',nThread = 1)
      ,by = ut]
    cat(' Finished.')
  } else
  {
    bel2mel$crel<-pbapply::pblapply(
      split(suppressWarnings(dbl2bel[,.(ut=ut %>% unique,batch=1:ceiling((ut %>% unique %>% length)/100))])[,.(ut,batch=sort(batch))],by = 'batch',keep.by = F)
      ,function(x) {
        r<-dbl2bel[x,data.table(do.call(rbind,lapply(1:(length(cr) - 1), function(y) matrix(cr[c(rep(y,length(cr) - y), (y + 1):length(cr))], ncol = 2)))),by = ut] %>% setnames(old=c('V1','V2'),new=c('cr1','cr2'))
        #if(DF) fwrite(x = r,file = sub('$','.txt',f),append=T,quote = F,sep = '\t',nThread = 1) else
        r
      }
      ,cl=nc
    )
  }
  ft<-sub('$','.txt',f)
  if(F){
    if(DF) {zip(zipfile = {z<-sub('$','.zip',ft);z},files = ft);file.remove(ft)}
    dfbel2mel<-zip_to_disk.frame(zipfile = z,outdir = '.',nchunks=nchnk,shardby=ec('cr1,cr2'))[[1]]
  }
  cat('\nStarting bel2mel.RData.txt -> dfbel2mel.')
  dfbel2mel<-csv_to_disk.frame(
    infile=ft
    #  ,outdir = '~/d/p/bel2mel.df' %>% path.expand %>% {dir.create(.);.}
    ,chunk_reader = 'data.table'
    ,nchunks=nchnk
    ,shardby=ec('cr1,cr2')
  )#[[1]]
  cat(' Finished.')
  file.remove('d/p/bel2mel-ew1.txt.gz')
  file.remove('d/p/bel2mel-ew2.txt.gz')
  cat('\nStarting dfbel2mel -> bel2mel-ew1.txt.gz.')
  dfbel2mel[,
            .SD[,.(ew =.N,ut=list(ut)),keyby=.(cr1,cr2)] %>% setkey(ew) %>% {
              .[.(1)] %>% fwrite('d/p/bel2mel-ew1.txt.gz',sep = '\t',sep2=c('"',',','"'),append=T)
              .[!.(1)] %>% fwrite('d/p/bel2mel-ew2.txt.gz',sep = '\t',sep2=c('"',',','"'),append=T)
            }
            ]
  cat(' Finished.')
  # bel2mel<-dfbel2mel[,.(ew =.N,ut=list(ut)),keyby=.(cr1,cr2)]
  # nr<-nrow(bel2mel)
  # cr1n<-bel2mel[,sum(is.na(cr1))]
  # cr2n<-bel2mel[,sum(is.na(cr2))]
  # iso<-sum(cr1n,cr2n)
  # new1<-bel2mel[.(1),on='ew'][,.N]
  # bel2mel %<>% .[!.(1),on='ew']
  # attr(bel2mel,'results')<-data.table(case=c('ew==1','ew>=2'),N=c(new1,nrow(bel2mel)))[,prop:=N/sum(N)]
  # 
  # if(!DF){
  #   bel2mel$crel %<>% rbindlist %>% setnames(old=c('V1','V2'),new=c('cr1','cr2'))
  #   bel2mel$crel %<>% {.[,.(ew =.N,ut=list(ut)),keyby=.(cr1,cr2)]}
  #   # trim edges where weight = 1
  #   new1<-bel2mel$crel[.(1),on='ew'][,.N]
  #   bel2mel$crel %<>% .[!.(1),on='ew']
  #   attr(bel2mel$crel,'results')<-data.table(case=c('ew==1','ew>=2'),N=c(new1,bel2mel$crel[,.N]))[,prop:=N/sum(N)]
  # }
  # save(bel2mel,file=f)
  # #browseURL('https://hub.gke.mybinder.org/user/brooksambrose-contours-p6m7z449/rstudio/export/bel2mel.RData?name=bel2mel.RData&file=~%2Fd%2Fp%2Fbel2mel.RData')
}
rm(f)
# if(DF) {
#   dfbel2mel<-as.disk.frame(bel2mel$crel[,!'ut'])
#   attr(dfbel2mel,'results')<-attributes(bel2mel$crel)$results
#   #rm(dbl2bel)
# }

```

```{r cpumem3}
cpumem(T)
```

<!--
# Unimodal graph

```{r}
library(igraph)
load('Out/el.RData')
g<-graph_from_edgelist(el %>% as.matrix)
V(g)$type<-grepl('^WOS:',V(g)$name)
system.time(cg<-cluster_louvain(as.undirected(g)))
ct<-apply(cg$memberships,1,function(x) x %>% table %>% sort(decreasing = T))
View(ct)
system.time(gcr<-bipartite_projection(g,which='false'))
save(gcr,file='Out/gcr.RData')

# count 
load('Out/gcr.RData')
system.time(et<-E(gcr)$weight %>% table %>% prop.table %>% `*`(100))
cbind(round(et,4))[1:10,]

# keep only edge weights greater than 1
gcr<-subgraph.edges(gcr,which(E(gcr)$weight>1))
save(gcr,file='Out/gcr_cull.RData')

# cluster culled graph
system.time(cgr<-cluster_louvain(gcr))
save(cgr,file='Out/cgr_culled.RData')

# rename cluster ids to be in sequence by size
sm<-list()
for(i in 1:nrow(cgr$memberships)) sm[[i]]<-factor(cgr$memberships[i,],levels=order(table(cgr$memberships[i,]),decreasing = T))
sm<-do.call(data.table,sm)
setnames(sm,paste0('h',ncol(sm):1))
sm[,cr:=cgr$names]
sm[,m:=as.integer(h1)] %>% setkey(m)
```

-->